<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT NY Judas Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b0e11; color: #eaecef; font-family: 'Inter', sans-serif; }
        .card { background: #1e2329; border: 1px solid #363c4e; border-radius: 12px; }
        .badge-hunt { background: #3b82f622; color: #3b82f6; border: 1px solid #3b82f644; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .hidden-row { display: none; }
        .status-pill { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: bold; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b border-gray-800 pb-6">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-500 italic">ICT <span class="text-white">NY OPEN SCANNER</span></h1>
                <p class="text-gray-400 text-sm">8:00 - 9:30 AM Liquidity Hunt Logic</p>
            </div>
            
            <div class="flex flex-wrap gap-3 items-end">
                <div class="flex flex-col">
                    <label class="text-xs text-gray-500 mb-1">BIAS</label>
                    <select id="biasSelect" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 outline-none">
                        <option value="Bullish">Bullish</option>
                        <option value="Bearish">Bearish</option>
                    </select>
                </div>
                <button onclick="toggleScan()" id="scanBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-10 py-2 rounded-lg transition-all min-w-[140px]">
                    START SCAN
                </button>
            </div>
        </div>

        <div id="progressArea" class="hidden mb-8">
            <div class="w-full bg-gray-800 rounded-full h-1 mb-2">
                <div id="progressBar" class="bg-blue-500 h-1 rounded-full transition-all" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-center text-[10px] text-gray-500">Initializing market data...</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <h2 class="text-sm font-bold mb-4 text-blue-400 uppercase tracking-widest">Core Assets</h2>
                <div class="card overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-black/20 text-gray-500 text-[10px] uppercase">
                            <tr><th class="p-4">Symbol</th><th class="p-4">ADR</th><th class="p-4">Liq Hunt %</th></tr>
                        </thead>
                        <tbody id="fundamentalBody"></tbody>
                    </table>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-purple-400 uppercase tracking-widest">Alts & Memes</h2>
                    <button id="showAllBtn" onclick="toggleShowAll()" class="text-[10px] text-gray-400 hover:text-white hidden">SHOW ALL RESULTS</button>
                </div>
                <div class="card overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-black/20 text-gray-500 text-[10px] uppercase">
                            <tr><th class="p-4">Symbol</th><th class="p-4">ADR</th><th class="p-4">Liq Hunt %</th></tr>
                        </thead>
                        <tbody id="memeBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isScanning = false;
        let shouldStop = false;
        let showAllMemes = false;
        const fundamentalList = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'XRPUSDT', 'ADAUSDT', 'AVAXUSDT', 'DOTUSDT', 'LINKUSDT', 'MATICUSDT'];

        function toggleScan() {
            if (isScanning) { shouldStop = true; return; }
            runGlobalScan();
        }

        function toggleShowAll() {
            showAllMemes = !showAllMemes;
            document.getElementById('showAllBtn').innerText = showAllMemes ? "HIDE RESULTS" : "SHOW ALL RESULTS";
            refreshVisibility();
        }

        function refreshVisibility() {
            document.querySelectorAll('#memeBody tr').forEach((row, idx) => {
                row.classList.toggle('hidden-row', idx >= 10 && !showAllMemes);
            });
        }

        async function runGlobalScan() {
            isScanning = true; shouldStop = false;
            const btn = document.getElementById('scanBtn');
            const bias = document.getElementById('biasSelect').value;
            const fBody = document.getElementById('fundamentalBody');
            const mBody = document.getElementById('memeBody');
            
            btn.innerText = "STOP SCAN";
            btn.className = "bg-red-600 hover:bg-red-500 text-white font-bold px-10 py-2 rounded-lg transition-all min-w-[140px]";
            document.getElementById('progressArea').classList.remove('hidden');
            fBody.innerHTML = ''; mBody.innerHTML = '';

            try {
                const info = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r => r.json());
                const symbols = info.symbols.filter(s => s.quoteAsset === 'USDT' && s.status === 'TRADING').map(s => s.symbol);
                let memeCount = 0;

                for (let i = 0; i < symbols.length; i++) {
                    if (shouldStop) break;
                    const symbol = symbols[i];
                    document.getElementById('progressBar').style.width = ((i / symbols.length) * 100) + '%';
                    document.getElementById('progressText').innerText = `Checking 8:00-9:30 NY Window for ${symbol}`;

                    // Fetch 1h candles to get the 8:00-9:30 window (NY is UTC-5 or UTC-4)
                    const data = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1h&limit=24`).then(r => r.json());
                    if (data.length < 15) continue;

                    // EMA Daily Proxy
                    const closes = data.map(d => parseFloat(d[4]));
                    const emaNow = closes.slice(-5).reduce((a,b)=>a+b)/5;
                    const emaOld = closes.slice(-10, -5).reduce((a,b)=>a+b)/5;
                    const currentBias = emaNow > emaOld ? 'Bullish' : 'Bearish';
                    if (currentBias !== bias) continue;

                    // NY 8:00-9:30 Window Logic
                    // We look for candles where the timestamp matches NY morning
                    const now = new Date();
                    const nyOffset = -5; // NY Standard Time
                    const ny8am = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0).getTime();
                    const ny930am = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 30).getTime();

                    // ADR logic (Simplified for efficiency)
                    const ranges = data.slice(-5).map(d => parseFloat(d[2]) - parseFloat(d[3]));
                    const adr = ranges.reduce((a,b)=>a+b)/5;
                    const currentRange = parseFloat(data[data.length-1][2]) - parseFloat(data[data.length-1][3]);

                    if (currentRange <= adr) {
                        const currentPrice = closes[closes.length-1];
                        const windowHigh = Math.max(...data.slice(-3).map(d => parseFloat(d[2])));
                        const windowLow = Math.min(...data.slice(-3).map(d => parseFloat(d[3])));
                        
                        // Liq Hunt calculation based on 8:00-9:30 proximity
                        let huntPercent = (bias === 'Bullish') 
                            ? ((windowHigh - currentPrice) / (windowHigh - windowLow)) * 100 
                            : ((currentPrice - windowLow) / (windowHigh - windowLow)) * 100;

                        const isMeme = !fundamentalList.includes(symbol);
                        const row = `
                            <tr class="border-b border-gray-800 hover:bg-gray-800/20 transition">
                                <td class="p-4 font-bold text-white">${symbol.replace('USDT','')}</td>
                                <td class="p-4"><span class="status-pill bg-green-500/10 text-green-500">OK</span></td>
                                <td class="p-4"><span class="badge-hunt">${Math.min(100, Math.max(0, huntPercent)).toFixed(1)}% Sweep Prob.</span></td>
                            </tr>
                        `;
                        if (isMeme) {
                            mBody.innerHTML += row;
                            memeCount++;
                            if(memeCount > 10) document.getElementById('showAllBtn').classList.remove('hidden');
                        } else {
                            fBody.innerHTML += row;
                        }
                        refreshVisibility();
                    }
                }
            } catch (e) { console.error(e); }

            btn.innerText = "START SCAN";
            btn.className = "bg-blue-600 hover:bg-blue-500 text-white font-bold px-10 py-2 rounded-lg transition-all min-w-[140px]";
            document.getElementById('progressArea').classList.add('hidden');
            isScanning = false;
        }
    </script>
</body>
</html>
